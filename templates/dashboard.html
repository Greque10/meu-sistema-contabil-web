<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ nome_empresa if nome_empresa else "Sistema Cont√°bil" }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Bem-vindo, {{ session.get('usuario', 'Utilizador') }}! 
                {% if nome_empresa %}
                    <small class="text-muted fs-5">({{ nome_empresa }})</small>
                {% endif %}
            </h2>
            <div>
                <button id="darkModeToggle" class="btn btn-outline-secondary me-2">Modo Escuro</button>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Sair</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-md-6">
                <!-- FORMUL√ÅRIO DE PARTIDAS DOBRADAS CORRIGIDO -->
                <div class="card shadow-sm p-4 mb-4">
                    <h5 class="card-title mb-3">Registar Transa√ß√£o (Partidas Dobradas)</h5>
                    <form method="POST" action="{{ url_for('dashboard') }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="conta_debito" class="form-label"><strong>Conta a Debitar:</strong></label>
                                <select name="conta_debito" id="conta_debito" class="form-select" required>
                                    <option value="" disabled selected>Selecione a conta de d√©bito...</option>
                                    {% for cod, nome_conta_obj in contas.items() %}
                                        {% set nome_exibicao = nome_conta_obj if nome_conta_obj is string else nome_conta_obj.get('nome', 'Desconhecida') %}
                                        <option value="{{ cod }}">{{ nome_exibicao }} ({{ cod }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="conta_credito" class="form-label"><strong>Conta a Creditar:</strong></label>
                                <select name="conta_credito" id="conta_credito" class="form-select" required>
                                    <option value="" disabled selected>Selecione a conta de cr√©dito...</option>
                                    {% for cod, nome_conta_obj in contas.items() %}
                                        {% set nome_exibicao = nome_conta_obj if nome_conta_obj is string else nome_conta_obj.get('nome', 'Desconhecida') %}
                                        <option value="{{ cod }}">{{ nome_exibicao }} ({{ cod }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                             <div class="col-md-6">
                                <label for="valor" class="form-label">Valor (R$):</label>
                                <input name="valor" id="valor" type="number" step="0.01" min="0.01" class="form-control" required>
                            </div>

                            <div class="col-md-6">
                                <label for="historico" class="form-label">Hist√≥rico da Transa√ß√£o:</label>
                                <input name="historico" id="historico" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="d-grid mt-3">
                             <button type="submit" class="btn btn-success">Registar Transa√ß√£o</button>
                        </div>
                    </form>
                </div>
                <!-- FIM DO FORMUL√ÅRIO -->

                <div class="d-grid gap-2 mb-3">
                    <a href="{{ url_for('diario') }}" class="btn btn-secondary">üìò Livro Di√°rio</a>
                    <a href="{{ url_for('razao') }}" class="btn btn-secondary">üìó Livro Raz√£o</a>
                    <a href="{{ url_for('balancete') }}" class="btn btn-secondary">üìí Balancete</a>
                    <a href="{{ url_for('grafico_data') }}" class="btn btn-info">üìä Gr√°fico por Data</a>
                    <a href="{{ url_for('historico_alteracoes') }}" class="btn btn-light border">üìú Hist√≥rico de Altera√ß√µes</a>
                </div>

                {% if admin_da_empresa and session.get('usuario') == admin_da_empresa %}
                    <div class="d-grid">
                        <a href="{{ url_for('cadastro') }}" class="btn btn-outline-primary">‚ûï Registar Novo Utilizador na Empresa</a>
                    </div>
                {% endif %}
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm mb-4"> 
                    <div class="card-body">
                        <h5 class="card-title text-center">Resumo Financeiro (D√©bitos x Cr√©ditos)</h5>
                        {% if total_d is defined and total_c is defined %}
                            <canvas id="graficoResumoDashboard" height="180"></canvas>
                            <script id="dashboardChartData" type="application/json">
                                {
                                    "total_d": {{ total_d | default(0) | float }},
                                    "total_c": {{ total_c | default(0) | float }}
                                }
                            </script>
                        {% else %}
                            <p class="text-center text-muted">N√£o h√° dados suficientes para exibir o resumo.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-center">Distribui√ß√£o de Despesas por Conta</h5>
                        {% if dados_despesas_pizza and dados_despesas_pizza.labels and dados_despesas_pizza.labels|length > 0 %}
                            <canvas id="graficoDespesasPizza" height="200"></canvas>
                             <script id="despesasPizzaChartData" type="application/json">
                                {{ dados_despesas_pizza | tojson | safe }}
                            </script>
                        {% else %}
                            <p class="text-center text-muted">N√£o h√° despesas (d√©bitos) registadas para exibir no gr√°fico.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Script para Gr√°fico de Barras do Dashboard (Resumo Financeiro) ---
            const canvasDashboard = document.getElementById('graficoResumoDashboard');
            let dashboardChartData = null;
            let chartInstanceDashboard = null;

            try {
                const jsonDataElement = document.getElementById('dashboardChartData');
                if (jsonDataElement && jsonDataElement.textContent.trim() !== "") {
                    dashboardChartData = JSON.parse(jsonDataElement.textContent);
                }
            } catch (e) { console.error("Erro ao analisar dados do gr√°fico de resumo:", e); }

            if (canvasDashboard && dashboardChartData) {
                const ctxDashboard = canvasDashboard.getContext('2d');
                chartInstanceDashboard = new Chart(ctxDashboard, {
                    type: 'bar',
                    data: {
                        labels: ['D√©bito', 'Cr√©dito'],
                        datasets: [{
                            label: 'Total (R$)',
                            data: [dashboardChartData.total_d, dashboardChartData.total_c],
                            backgroundColor: ['rgba(220, 53, 69, 0.7)', 'rgba(25, 135, 84, 0.7)'],
                            borderColor: ['rgba(220, 53, 69, 1)', 'rgba(25, 135, 84, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: true,
                        plugins: { legend: { display: false }, title: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            // --- Script para Gr√°fico de Pizza (Despesas) ---
            const canvasDespesasPizza = document.getElementById('graficoDespesasPizza');
            let despesasPizzaData = null;
            let chartInstanceDespesasPizza = null;

            try {
                const jsonDataElementPizza = document.getElementById('despesasPizzaChartData');
                if (jsonDataElementPizza && jsonDataElementPizza.textContent.trim() !== "") {
                    despesasPizzaData = JSON.parse(jsonDataElementPizza.textContent);
                }
            } catch (e) { console.error("Erro ao analisar dados do gr√°fico de pizza:", e); }

            if (canvasDespesasPizza && despesasPizzaData && despesasPizzaData.labels && despesasPizzaData.labels.length > 0) {
                const ctxPizza = canvasDespesasPizza.getContext('2d');
                const pizzaBackgroundColors = [
                    'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                    'rgba(201, 203, 207, 0.7)', 'rgba(100, 150, 200, 0.7)'
                ];
                chartInstanceDespesasPizza = new Chart(ctxPizza, {
                    type: 'doughnut',
                    data: {
                        labels: despesasPizzaData.labels,
                        datasets: [{
                            label: 'Distribui√ß√£o de Despesas',
                            data: despesasPizzaData.data,
                            backgroundColor: pizzaBackgroundColors.slice(0, despesasPizzaData.labels.length),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true,
                        plugins: {
                            title: { display: false },
                            legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) {
                                            label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- Fun√ß√µes para atualizar cores dos gr√°ficos ---
            window.updateChartColorsForDashboard = function(isDarkMode) {
                if (chartInstanceDashboard) {
                    const newTextColor = isDarkMode ? 'rgba(224, 224, 224, 0.87)' : 'rgba(0, 0, 0, 0.87)';
                    const newGridColor = isDarkMode ? 'rgba(224, 224, 224, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    const scales = chartInstanceDashboard.options.scales;
                    if (scales) {
                        if (scales.x && scales.x.ticks) scales.x.ticks.color = newTextColor;
                        if (scales.y && scales.y.ticks) scales.y.ticks.color = newTextColor;
                        if (scales.y && scales.y.grid) scales.y.grid.color = newGridColor;
                    }
                    chartInstanceDashboard.update();
                }
            };
            window.updateChartColorsForPieDashboard = function(isDarkMode) {
                if (chartInstanceDespesasPizza) {
                    const newLegendColor = isDarkMode ? '#e0e0e0' : '#333';
                    if(chartInstanceDespesasPizza.options.plugins.legend) {
                        chartInstanceDespesasPizza.options.plugins.legend.labels.color = newLegendColor;
                    }
                    chartInstanceDespesasPizza.update();
                }
            };
            
            // Chama as fun√ß√µes de atualiza√ß√£o no carregamento inicial
            const isDarkModeInitial = document.body.classList.contains('dark-mode');
            if (typeof window.updateChartColorsForDashboard === 'function') {
                window.updateChartColorsForDashboard(isDarkModeInitial);
            }
            if (typeof window.updateChartColorsForPieDashboard === 'function') {
                window.updateChartColorsForPieDashboard(isDarkModeInitial);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>